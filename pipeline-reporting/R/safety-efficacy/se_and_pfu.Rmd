---
title: "SE & PFU Reports"
description: |
  Reporting used to track SE and PFU
output:
  html_document:
    toc: true
    theme: cerulean
date: '`r Sys.time()`'
---

Notes:

- Report is refreshed hourly 9-5pm EAT, once 12AM EAT
- Please reach out to atediarjo@gmail.com for bug reports

Description:

This report is used to monitor data collection for SE & PFU. Design specs are based on this [Reporting Document](https://docs.google.com/spreadsheets/d/1yzrP80EjjPtTan3Dl_rSoQOUu1sARKHj9hd1k4-nPc4/edit#gid=1969855170)

```{r, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(
  comment = '', 
  echo = FALSE,
  message = FALSE,
  cache=FALSE,
  warning=FALSE
)
```

```{r, echo=FALSE, message=FALSE}
library(reactable)
library(data.table)
library(dplyr)
library(htmltools)
library(glue)
library(fontawesome)
library(ggplot2)
library(plotly)
library(tidyr)
```

```{r}
# STATIC VARIABLES FOR I/O
ENV_PIPELINE_STAGE <- Sys.getenv("PIPELINE_STAGE")
DATA_STAGING_BUCKET_NAME <- 'databrew.org'
DATA_LAKE_BUCKET_NAME <- 'bohemia-lake-db'
PROJECT_SOURCE <- 'kwale'
SE_FOLDER_TARGET <- glue::glue('{PROJECT_SOURCE}/clean-form')
```

```{r}
tryCatch({
  logger::log_info('Attempt AWS login')
  # login to AWS - this will be bypassed if executed in CI/CD environment
  cloudbrewr::aws_login(
    role_name = 'cloudbrewr-aws-role',
    profile_name =  'cloudbrewr-aws-role',
    pipeline_stage = ENV_PIPELINE_STAGE)

}, error = function(e){
  logger::log_error('AWS Login Failed')
  stop(e$message)
})
```

```{r}
pad_hhid <- function(data){
  if('hhid' %in% names(data)){
    data %>%
      dplyr::mutate(hhid = stringr::str_pad(hhid, 5, pad = "0"))
  }else{
    data
  }
}

wrap_download <- function(reactable_obj, element_id, output_filename){
  onclick_command <- glue::glue(
    "Reactable.downloadDataCSV('{element_id}', '{output_filename}')")
  htmltools::browsable(
    tagList(
      tags$button(
        tagList(fontawesome::fa("download"), "Download as CSV"),
        onclick = onclick_command),
      reactable_obj
    ))
}

plot_submission_by_day <- function(data) {
  submissions <- data %>%
    dplyr::mutate(metric_date = lubridate::date(SubmissionDate)) %>%
    dplyr::group_by(metric_date) %>%
    dplyr::summarise(n_submission = n_distinct(KEY))%>%
    dplyr::select(`date` = metric_date,
                  `submission` = n_submission)

  submissions_by_dow <- submissions %>%
    dplyr::mutate(dow = lubridate::wday(date, label = TRUE)) %>%
    dplyr::group_by(dow) %>%
    dplyr::summarise(submission = sum(submission))

  p1 <- submissions %>%
    ggplot(aes(x = `date`, y = `submission`)) +
    geom_line() +
    geom_point() +
    theme_minimal() +
    labs(
      y = 'Submissions',
      x = '')

  p2 <- submissions_by_dow %>%
    ggplot(aes(x = `dow`, y = `submission`)) +
    geom_col() +
    theme_minimal() +
    labs(
      y = 'Submissions',
      x = '')

  subplot(ggplotly(p1), ggplotly(p2))
}


prep_safety_tbl <- function(safety_df, 
                            indicator,
                            group_cols,
                            target_df,
                            visit_list,
                            safetynew_df = NULL){
  
  if(is.null(safetynew_df) || nrow(safetynew_df) == 0){
      output <- safety_df %>% 
        dplyr::group_by(across(any_of(group_cols))) %>%
        dplyr::summarise(
          hh = n_distinct(hhid),
          ind = n_distinct(extid))
  }else {
      safety_progress <- safety_df %>% 
        dplyr::group_by(across(any_of(group_cols))) %>%
        dplyr::summarise(
          hh = n_distinct(hhid),
          ind = n_distinct(extid))
      
      safetynew_progress <- safetynew_df %>% 
        dplyr::group_by(across(all_of(group_cols))) %>%
        dplyr::summarise(ind = n_distinct(extid))  
  
      output <- safety_progress %>% 
        dplyr::left_join(safetynew_progress, by = c(group_cols)) %>% 
        dplyr::mutate(across(everything(), .fns = ~replace_na(.,0))) %>%
        dplyr::mutate(ind = ind.x + ind.y) %>% 
        dplyr::select(any_of(group_cols), hh, ind)
  }
  
  
  # edge case 1: create 0 placeholder
  if(nrow(output) == 0){
    output <- tibble(visit = visit_list) %>% 
          dplyr::mutate(hh = 0, ind = 0) %>% 
          dplyr::select(visit, 
                        any_of(group_cols), 
                        hh, 
                        ind)
    
    output <- target_df %>% 
          dplyr::mutate(hh = 0, ind = 0) %>% 
          dplyr::select(visit, 
                        any_of(group_cols), 
                        hh, 
                        ind)
  }
  
  output <- output %>%
    dplyr::mutate(metric = indicator)
  
  return(output)
}


get_safety_target_by_assignment <- function(visit_list){
  # create targets
  v0_target <- v0 %>% 
      dplyr::inner_join(v0_repeat, by = c('KEY' = 'PARENT_KEY')) %>%
      dplyr::inner_join(assignment, by = c('geo_cluster_num' = 'cluster_number')) %>% 
      dplyr::group_by(assignment) %>%
      dplyr::summarise(hh_target = n_distinct(hhid),
                       ind_target = n_distinct(extid))  
  
  safetynew_target <- safetynew %>% 
      dplyr::inner_join(safetynew_repeat_individual, by = c('KEY' = 'PARENT_KEY')) %>%
      dplyr::left_join(assignment, by = c('cluster' = 'cluster_number')) %>% 
      dplyr::group_by(assignment) %>%
      dplyr::summarise(ind_target = n_distinct(extid))  
  
  target <- v0_target %>% 
    dplyr::left_join(safetynew_target, by = 'assignment') %>% 
    dplyr::mutate(across(everything(), .fns = ~replace_na(.,0))) %>%
    dplyr::mutate(ind_target = ind_target.x + ind_target.y) %>% 
    dplyr::select(assignment, 
                  hh_target,
                  ind_target)
  
    target <- purrr::map_dfr(visit_list, function(visit){
      target %>% 
          dplyr::mutate(visit = visit)
    })
  
  return(target)
}

get_safety_target_by_cluster_and_village <- function(visit_list){
    v0_target <- v0 %>% 
      dplyr::inner_join(v0_repeat, by = c('KEY' = 'PARENT_KEY')) %>%
      dplyr::group_by(geo_cluster_num, village) %>%
      dplyr::summarise(hh_target = n_distinct(hhid),
                       ind_target = n_distinct(extid)) %>% 
      dplyr::select(cluster = geo_cluster_num, everything()) %>% 
      tidyr::drop_na()
  
  safetynew_target <- safetynew %>% 
      dplyr::inner_join(safetynew_repeat_individual, by = c('KEY' = 'PARENT_KEY')) %>%
      dplyr::left_join(v0 %>% 
                         dplyr::select(hhid, village) %>% 
                         dplyr::distinct(), 
                       by = 'hhid') %>%
      dplyr::left_join(assignment, 
                       by = c('cluster' = 'cluster_number')) %>% 
      dplyr::group_by(cluster, village) %>%
      dplyr::summarise(ind_target = n_distinct(extid))  
  
  target <- v0_target %>% 
    dplyr::left_join(safetynew_target, by = c('cluster','village')) %>% 
    dplyr::mutate(across(everything(), .fns = ~replace_na(.,0))) %>%
    dplyr::mutate(ind_target = ind_target.x + ind_target.y) %>% 
    dplyr::select(cluster,
                  village,
                  hh_target,
                  ind_target)
  
    target <- purrr::map_dfr(visit_list, function(visit){
      target %>% 
          dplyr::mutate(visit = visit)
    })
  
  return(target)
}


get_efficacy_target_by_assignment <- function(visit_list){
  # v0 merged_tbl
  v0_merged_tbl <- v0 %>% 
      dplyr::inner_join(v0_repeat, by = c('KEY' = 'PARENT_KEY'))  %>%
      dplyr::inner_join(
        assignment, 
        by = c('geo_cluster_num' = 'cluster_number'))
  
  # create targets
  target <- v0_merged_tbl %>% 
      dplyr::inner_join(
        efficacy_selection, 
        by = c('extid')) %>% 
      dplyr::group_by(assignment) %>%
      dplyr::summarise(hh_target = n_distinct(hhid),
                       ind_target = n_distinct(extid))  
  
  # create targets
  remove_from_next_target <- efficacy %>% 
      dplyr::filter(efficacy_status == 'eos') %>% 
      dplyr::select(hhid, extid, visit) %>%
      dplyr::inner_join(v0_merged_tbl %>% dplyr::select(assignment, extid), 
                        by = 'extid') %>% 
      dplyr::group_by(assignment, visit) %>%
      dplyr::summarise(hh_rm = n_distinct(hhid),
                       ind_rm = n_distinct(extid))  %>%
    dplyr::mutate(
        next_visit_num = 
            as.numeric(glue::glue(
              stringr::str_extract(visit, "[0-9]+"))) + 1,
        visit = glue::glue('V{next_visit_num}'))
  
    target <- purrr::map_dfr(visit_list, function(visit){
      target %>% 
          dplyr::mutate(visit = visit) %>% 
          dplyr::left_join(remove_from_next_target, 
                           by = c('visit', 'assignment')) %>% 
          dplyr::mutate(across(everything(), .fns = ~replace_na(.,0))) %>%
          dplyr::mutate(hh_target = hh_target - hh_rm,
                        ind_target = ind_target - ind_rm)
    }) %>% dplyr::select(assignment, ends_with('target'), visit)
  
  return(target)
}

get_efficacy_target_by_cluster_and_village <- function(visit_list){
  # v0 merged_tbl
  v0_merged_tbl <- v0 %>% 
      dplyr::inner_join(v0_repeat, by = c('KEY' = 'PARENT_KEY'))  %>%
      dplyr::inner_join(
        assignment, 
        by = c('geo_cluster_num' = 'cluster_number'))
  
  # create targets
  target <- v0_merged_tbl %>% 
      dplyr::inner_join(
        efficacy_selection, 
        by = c('extid')) %>% 
      dplyr::group_by(geo_cluster_num, village) %>%
      dplyr::summarise(hh_target = n_distinct(hhid),
                       ind_target = n_distinct(extid)) %>% 
      dplyr::select(cluster = geo_cluster_num, everything())
  
  # target to remove next visit
  remove_from_next_target <- efficacy %>% 
      dplyr::filter(efficacy_status == 'eos') %>% 
      dplyr::select(hhid, extid, visit, cluster, village) %>%
      dplyr::inner_join(v0_merged_tbl %>% dplyr::select(extid), 
                        by = 'extid') %>% 
      dplyr::group_by(visit, cluster, village) %>%
      dplyr::summarise(hh_rm = n_distinct(hhid),
                       ind_rm = n_distinct(extid)) %>%
    dplyr::mutate(
        next_visit_num = 
            as.numeric(glue::glue(
              stringr::str_extract(visit, "[0-9]+"))) + 1,
        visit = glue::glue('V{next_visit_num}'))
  
    target <- purrr::map_dfr(visit_list, function(visit){
      target %>% 
          dplyr::mutate(visit = visit) %>% 
          dplyr::left_join(remove_from_next_target, 
                           by = c('visit', 'cluster', 'village')) %>% 
          dplyr::mutate(across(everything(), .fns = ~replace_na(.,0))) %>%
          dplyr::mutate(hh_target = hh_target - hh_rm,
                        ind_target = ind_target - ind_rm)
    }) %>% dplyr::select(cluster, 
                         village, 
                         ends_with('target'), 
                         visit)
  
  return(target)
}

```


```{r}
#################################
# Fetch v0 demography
#################################
worker_registration <- cloudbrewr::aws_s3_get_table(
  bucket = 'databrew.org',
  key = 'kwale/clean-form/reconaregistration/reconaregistration.csv'
) %>%
  pad_hhid()

v0 <- cloudbrewr::aws_s3_get_table(
  bucket = 'databrew.org',
  key = 'kwale/clean-form/v0demography/v0demography.csv'
) %>%
  pad_hhid()

v0_repeat <- cloudbrewr::aws_s3_get_table(
  bucket = 'databrew.org',
  key = 'kwale/clean-form/v0demography/v0demography-repeat_individual.csv'
) %>%
  pad_hhid()


efficacy <- cloudbrewr::aws_s3_get_table(
  bucket = 'databrew.org',
  key = glue::glue('{PROJECT_SOURCE}/clean-form/efficacy/efficacy.csv')) %>%
  pad_hhid()

safety <- cloudbrewr::aws_s3_get_table(
  bucket = 'databrew.org',
  key = glue::glue('{PROJECT_SOURCE}/clean-form/safety/safety.csv')) %>%
  pad_hhid()

safetynew <- cloudbrewr::aws_s3_get_table(
  bucket = 'databrew.org',
  key = glue::glue('{PROJECT_SOURCE}/clean-form/safetynew/safetynew.csv')) %>%
  pad_hhid()

safety_repeat_individual <- cloudbrewr::aws_s3_get_table(
  bucket = 'databrew.org',
  key = glue::glue('{PROJECT_SOURCE}/clean-form/safety/safety-repeat_individual.csv')) %>%
  pad_hhid()

safetynew_repeat_individual <- cloudbrewr::aws_s3_get_table(
  bucket = 'databrew.org',
  key = glue::glue('{PROJECT_SOURCE}/clean-form/safetynew/safetynew-repeat_individual.csv')) %>%
  pad_hhid()


assignment <- cloudbrewr::aws_s3_get_table(
  bucket = 'bohemia-lake-db',
  key = glue::glue('bohemia_prod/dim_arm_assignment/assignments.csv')) %>%
  pad_hhid()


efficacy_selection <- cloudbrewr::aws_s3_get_table(
  bucket = 'bohemia-lake-db',
  key = glue::glue('bohemia_ext/efficacy_selection.csv')) %>%
  pad_hhid()
```


```{r}
#### DATA PREP

# village mapping
village_mapping <- v0 %>% 
    dplyr::select(hhid, village) %>% 
    unique()

# prep safety table
safety_merged_tbl <- safety %>% 
  dplyr::inner_join(safety_repeat_individual, by = c('KEY' = 'PARENT_KEY')) %>% 
  dplyr::left_join(assignment, by = c('cluster' = 'cluster_number')) %>% 
  dplyr::left_join(village_mapping, by = 'hhid')

# prep safety new
safetynew_merged_tbl <- safetynew %>% 
  dplyr::inner_join(safetynew_repeat_individual, by = c('KEY' = 'PARENT_KEY')) %>% 
  dplyr::left_join(assignment, by = c('cluster' = 'cluster_number')) %>% 
  dplyr::left_join(village_mapping, by = 'hhid')

# efficacy df
efficacy_df <-  efficacy %>% 
    dplyr::inner_join(assignment %>% 
                          dplyr::select(cluster_number, assignment), 
                      by = c('cluster' = 'cluster_number'))


# goals
target_safety_by_assignment = get_safety_target_by_assignment(
  visit_list =  safety_merged_tbl$visit %>% unique())
target_safety_by_cluster_and_village = get_safety_target_by_cluster_and_village(
  visit_list =  safety_merged_tbl$visit %>% unique())

target_efficacy_by_assignment  <- get_efficacy_target_by_assignment(
  visit_list =  efficacy$visit %>% unique())
target_efficacy_by_cluster_and_village  <- get_efficacy_target_by_cluster_and_village(
  visit_list =  efficacy$visit %>% unique())

```

## Submissions by Day

### Safety
```{r, fig.width=10, fig.height=3}
plot_submission_by_day(safety)
```

### Safety New
```{r, fig.width=10, fig.height=3}
plot_submission_by_day(safetynew)
```

### Efficacy
```{r, fig.width=10, fig.height=3}
plot_submission_by_day(efficacy)
```

## S&E by Assignment

### Safety

```{r}
data_list <- list()
group_cols <- c('visit','assignment')
unique_visit_list <- safety_merged_tbl$visit %>% unique()

# prep safety overall
data_list$safety_overall <- prep_safety_tbl(
    safety_df = safety_merged_tbl, 
    safetynew_df = safetynew_merged_tbl, 
    indicator = 'safety_overall',
    target_df = target_safety_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety in
data_list$safety_in <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(safety_status == 'in'),
  safetynew_df = safetynew_merged_tbl %>% 
    dplyr::filter(safety_status == 'in'),
  indicator = 'safety_in',
    target_df = target_safety_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety in & absent
data_list$safety_in_absent <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>%
    dplyr::filter(
      safety_status == 'in',
      person_absent_reason == 'Absent'),
  indicator = 'safety_in_absent',
    target_df = target_safety_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety refusal
data_list$safety_refusal <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(safety_status == 'refusal'),
  safetynew_df = safetynew_merged_tbl %>% 
    dplyr::filter(safety_status == 'refusal'),
  indicator = 'safety_refusal',
    target_df = target_safety_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety eos
data_list$safety_eos <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(safety_status == 'eos'),
  safetynew_df = safetynew_merged_tbl %>% 
    dplyr::filter(safety_status == 'eos'),
  indicator = 'safety_eos',
    target_df = target_safety_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety eos
data_list$safety_out <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(safety_status == 'out'),
  safetynew_df = safetynew_merged_tbl %>% 
    dplyr::filter(safety_status == 'out'),
  indicator = 'safety_out',
    target_df = target_safety_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety out absent
data_list$safety_out_absent <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(safety_status == 'out',
                  person_absent_reason == 'Absent'),
    indicator = 'safety_out_absent',
   target_df = target_safety_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)


# prep safety out absent
data_list$safety_migrated <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(person_absent_reason == 'Migrated'),
  indicator = 'safety_migrated',
    target_df = target_safety_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety out absent
data_list$safety_died <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(person_absent_reason == 'Died'),
  indicator = 'safety_died',
    target_df = target_safety_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)
```

```{r}
summary <- target_safety_by_assignment %>%
    dplyr::left_join(purrr::reduce(data_list, dplyr::bind_rows), by = group_cols) %>%
    tidyr::pivot_wider(names_from = metric, 
                       id_cols = c(any_of(group_cols), 'hh_target', 'ind_target'),
                       values_from = c('ind','hh')) %>% 
    dplyr::mutate(hh_safety_overall_perc = hh_safety_overall / hh_target,
                  ind_safety_overall_perc = ind_safety_overall / ind_target) %>% 
    dplyr::select(any_of(group_cols),
                  hh_target, 
                  ind_target, 
                  hh_safety_overall,
                  hh_safety_overall_perc,
                  ind_safety_overall,
                  ind_safety_overall_perc,
                  ind_safety_died,
                  ind_safety_migrated,
                  ind_safety_in,
                  ind_safety_in_absent,
                  ind_safety_out,
                  ind_safety_out_absent,
                  ind_safety_eos,
                  ind_safety_refusal) %>%
  dplyr::mutate(across(everything(), .fns = ~replace_na(.,0)))


element_id <- 'tbl1'
tbl <- reactable(
    summary %>% dplyr::ungroup(),
    columns = list(
        visit = colDef(name = 'Visit', filterable = TRUE),
        assignment = colDef(name = 'Arm', filterable = TRUE),
        hh_target = colDef(name = "Target Household"),
        ind_target = colDef(name = "Target Individual"),
        hh_safety_overall = colDef(name = "Household Visits"),
        ind_safety_overall = colDef(name = "Individual Visits"),
        hh_safety_overall_perc = colDef(
            name = 'Household Visit %',
            format = colFormat(percent = TRUE, digits = 1),
            style = function(value) {
                if (value >= 1) {
                    color <- "#008000"
                } else if (value < 1) {
                    color <- "#e00000"
                } else {
                    color <- "#777"
                }
                list(color = color, fontWeight = "bold")
            }),
        ind_safety_overall_perc = colDef(
            name = 'Individual Visit %',
            format = colFormat(percent = TRUE, digits = 1),
            style = function(value) {
                if (value >= 1) {
                    color <- "#008000"
                } else if (value < 1) {
                    color <- "#e00000"
                } else {
                    color <- "#777"
                }
                list(color = color, fontWeight = "bold")
            }),
        ind_safety_died = colDef(name = "Individual Safety Died"),
        ind_safety_migrated = colDef(name = "Individual Safety Migrated"),
        ind_safety_in = colDef(name = "Individual Safety-In"),
        ind_safety_in_absent = colDef(name = "Individual Safety-In Absent"),
        ind_safety_out = colDef(name = "Individual Safety-Out"),
        ind_safety_out_absent = colDef(name = "Individual Safety-Out Absent"),
        ind_safety_eos = colDef(name = "Individual Safety EOS"),
        ind_safety_refusal = colDef(name = "Individual Safety Refusal")
    ),
    columnGroups = list(
      colGroup(name = "Target", 
               columns = c('hh_target', 'ind_target')),
      colGroup(name = "Overall Completion", 
               columns = c('hh_safety_overall', 
                           'hh_safety_overall_perc', 
                           'ind_safety_overall', 
                           'ind_safety_overall_perc'))),
    highlight = TRUE,
    resizable = TRUE,
    bordered = TRUE,
    striped = TRUE,
    elementId = element_id
)

wrap_download(
  tbl, 
  element_id,
  'safety_by_arm_assignment.csv')
```

### Efficacy

```{r}
data_list <- list()
group_cols <- c('visit','assignment')
unique_visit_list <- efficacy_df$visit %>% unique()

# prep safety overall
data_list$overall <- prep_safety_tbl(
    safety_df = efficacy_df, 
    indicator = 'efficacy_overall',
    target_df = target_efficacy_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety in
data_list$in_status <- prep_safety_tbl(
  safety_df =  efficacy_df %>% 
    dplyr::filter(efficacy_status == 'in'),
  indicator = 'efficacy_in',
    target_df = target_efficacy_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety in & absent
data_list$in_absent_status <- prep_safety_tbl(
  safety_df =  efficacy_df %>%
    dplyr::filter(
      efficacy_status == 'in',
      person_absent_reason == 'Absent'),
  indicator = 'efficacy_in_absent',
    target_df = target_efficacy_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety refusal
data_list$refusal_status <- prep_safety_tbl(
  safety_df = efficacy_df %>% 
    dplyr::filter(efficacy_status == 'refusal'),
  indicator = 'efficacy_refusal',
    target_df = target_efficacy_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety eos
data_list$eos_status <- prep_safety_tbl(
  safety_df = efficacy_df %>% 
    dplyr::filter(efficacy_status == 'eos'),
  indicator = 'efficacy_eos',
    target_df = target_efficacy_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety eos
data_list$out_status <- prep_safety_tbl(
  safety_df = efficacy_df %>% 
    dplyr::filter(efficacy_status == 'out'),
  indicator = 'efficacy_out',
    target_df = target_efficacy_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)

# prep safety out absent
data_list$out_absent_status <- prep_safety_tbl(
  safety_df = efficacy_df %>% 
    dplyr::filter(safety_status == 'out',
                  person_absent_reason == 'Absent'),
    indicator = 'efficacy_out_absent',
    target_df = target_efficacy_by_assignment,
    group_cols = group_cols,
    visit_list = unique_visit_list
)


# prep safety out absent
data_list$migrated_status <- prep_safety_tbl(
  safety_df = efficacy_df %>% 
    dplyr::filter(person_absent_reason == 'Migrated'),
  indicator = 'efficacy_migrated',
  target_df = target_efficacy_by_assignment,
  group_cols = group_cols,
  visit_list = unique_visit_list
)

# prep safety out absent
data_list$died_status <- prep_safety_tbl(
  safety_df = efficacy_df %>% 
    dplyr::filter(person_absent_reason == 'Died'),
  indicator = 'efficacy_died',
  target_df = target_efficacy_by_assignment,
  group_cols = group_cols,
  visit_list = unique_visit_list
)
```

```{r}
summary <- target_efficacy_by_assignment %>%
    dplyr::inner_join(purrr::reduce(data_list, dplyr::bind_rows), by = group_cols) %>%
    tidyr::pivot_wider(names_from = metric, 
                       id_cols = c(any_of(group_cols), 'hh_target', 'ind_target'),
                       values_from = c('ind','hh')) %>% 
    dplyr::mutate(hh_efficacy_overall_perc = hh_efficacy_overall / hh_target,
                  ind_efficacy_overall_perc = ind_efficacy_overall / ind_target) %>% 
    dplyr::select(any_of(group_cols),
                  hh_target, 
                  ind_target, 
                  hh_efficacy_overall,
                  hh_efficacy_overall_perc,
                  ind_efficacy_overall,
                  ind_efficacy_overall_perc,
                  ind_efficacy_died,
                  ind_efficacy_migrated,
                  ind_efficacy_in,
                  ind_efficacy_in_absent,
                  ind_efficacy_out,
                  ind_efficacy_out_absent,
                  ind_efficacy_eos,
                  ind_efficacy_refusal) %>%
  dplyr::mutate(across(everything(), .fns = ~replace_na(.,0)))


element_id <- 'tbl2'
tbl <- reactable(
    summary %>% dplyr::ungroup(),
    columns = list(
        visit = colDef(name = 'Visit', filterable = TRUE),
        assignment = colDef(name = 'Arm', filterable = TRUE),
        hh_target = colDef(name = "Target Household"),
        ind_target = colDef(name = "Target Individual"),
        hh_efficacy_overall = colDef(name = "Household Visits"),
        ind_efficacy_overall = colDef(name = "Individual Visits"),
        hh_efficacy_overall_perc = colDef(
            name = 'Household Visit %',
            format = colFormat(percent = TRUE, digits = 1),
            style = function(value) {
                if (value >= 1) {
                    color <- "#008000"
                } else if (value < 1) {
                    color <- "#e00000"
                } else {
                    color <- "#777"
                }
                list(color = color, fontWeight = "bold")
            }),
        ind_efficacy_overall_perc = colDef(
            name = 'Individual Visit %',
            format = colFormat(percent = TRUE, digits = 1),
            style = function(value) {
                if (value >= 1) {
                    color <- "#008000"
                } else if (value < 1) {
                    color <- "#e00000"
                } else {
                    color <- "#777"
                }
                list(color = color, fontWeight = "bold")
            }),
        ind_efficacy_died = colDef(name = "Individual Safety Died"),
        ind_efficacy_migrated = colDef(name = "Individual Safety Migrated"),
        ind_efficacy_in = colDef(name = "Individual Safety-In"),
        ind_efficacy_in_absent = colDef(name = "Individual Safety-In Absent"),
        ind_efficacy_out = colDef(name = "Individual Safety-Out"),
        ind_efficacy_out_absent = colDef(name = "Individual Safety-Out Absent"),
        ind_efficacy_eos = colDef(name = "Individual Safety EOS"),
        ind_efficacy_refusal = colDef(name = "Individual Safety Refusal")
    ),
    columnGroups = list(
      colGroup(name = "Target", 
               columns = c('hh_target', 'ind_target')),
      colGroup(name = "Overall Completion", 
               columns = c('hh_efficacy_overall', 
                           'hh_efficacy_overall_perc', 
                           'ind_efficacy_overall', 
                           'ind_efficacy_overall_perc'))),
    highlight = TRUE,
    resizable = TRUE,
    bordered = TRUE,
    striped = TRUE,
    elementId = element_id
)

wrap_download(
  tbl, 
  element_id,
  'efficacy_by_arm_assignment.csv')
```

## S&E by Cluster & Village

### Safety

```{r}
data_list <- list()
group_cols <- c('visit','cluster', 'village')
unique_visit_list <- safety_merged_tbl$visit %>% unique()

# prep safety overall
data_list$safety_overall <- prep_safety_tbl(
    safety_df = safety_merged_tbl, 
    safetynew_df = safetynew_merged_tbl, 
    indicator = 'safety_overall',
    target_df = target_safety_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety in
data_list$safety_in <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(safety_status == 'in'),
  safetynew_df = safetynew_merged_tbl %>% 
    dplyr::filter(safety_status == 'in'),
  indicator = 'safety_in',
    target_df = target_safety_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety in & absent
data_list$safety_in_absent <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>%
    dplyr::filter(
      safety_status == 'in',
      person_absent_reason == 'Absent'),
  indicator = 'safety_in_absent',
    target_df = target_safety_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety refusal
data_list$safety_refusal <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(safety_status == 'refusal'),
  safetynew_df = safetynew_merged_tbl %>% 
    dplyr::filter(safety_status == 'refusal'),
  indicator = 'safety_refusal',
    target_df = target_safety_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety eos
data_list$safety_eos <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(safety_status == 'eos'),
  safetynew_df = safetynew_merged_tbl %>% 
    dplyr::filter(safety_status == 'eos'),
  indicator = 'safety_eos',
    target_df = target_safety_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety eos
data_list$safety_out <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(safety_status == 'out'),
  safetynew_df = safetynew_merged_tbl %>% 
    dplyr::filter(safety_status == 'out'),
  indicator = 'safety_out',
    target_df = target_safety_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety out absent
data_list$safety_out_absent <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(safety_status == 'out',
                  person_absent_reason == 'Absent'),
    indicator = 'safety_out_absent',
    target_df = target_safety_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety out absent
data_list$safety_migrated <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(person_absent_reason == 'Migrated'),
  indicator = 'safety_migrated',
  target_df = target_safety_by_cluster_and_village,
  group_cols = group_cols,
  visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety out absent
data_list$safety_died <- prep_safety_tbl(
  safety_df = safety_merged_tbl %>% 
    dplyr::filter(person_absent_reason == 'Died'),
  indicator = 'safety_died',
  target_df = target_safety_by_cluster_and_village,
  group_cols = group_cols,
  visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))
```

```{r}
summary <- target_safety_by_cluster_and_village %>%
    dplyr::inner_join(purrr::reduce(data_list, dplyr::bind_rows), by = group_cols) %>%
    tidyr::pivot_wider(names_from = metric, 
                       id_cols = c(any_of(group_cols), 'hh_target', 'ind_target'),
                       values_from = c('ind','hh')) %>% 
    dplyr::mutate(hh_safety_overall_perc = hh_safety_overall / hh_target,
                  ind_safety_overall_perc = ind_safety_overall / ind_target) %>% 
    dplyr::select(any_of(group_cols),
                  hh_target, 
                  ind_target, 
                  hh_safety_overall,
                  hh_safety_overall_perc,
                  ind_safety_overall,
                  ind_safety_overall_perc,
                  ind_safety_died,
                  ind_safety_migrated,
                  ind_safety_in,
                  ind_safety_in_absent,
                  ind_safety_out,
                  ind_safety_out_absent,
                  ind_safety_eos,
                  ind_safety_refusal) %>%
  dplyr::mutate(across(everything(), .fns = ~replace_na(.,0)))


element_id <- 'tbl3'
tbl <- reactable(
    summary %>% dplyr::ungroup(),
    columns = list(
        visit = colDef(name = 'Visit', filterable = TRUE),
        cluster = colDef(name = 'Cluster', filterable = TRUE),
        village = colDef(name = 'Village', filterable = TRUE, minWidth = 140),
        hh_target = colDef(name = "Target Household"),
        ind_target = colDef(name = "Target Individual"),
        hh_safety_overall = colDef(name = "Household Visits"),
        ind_safety_overall = colDef(name = "Individual Visits"),
        hh_safety_overall_perc = colDef(
            name = 'Household Visit %',
            format = colFormat(percent = TRUE, digits = 1),
            style = function(value) {
                if (value >= 1) {
                    color <- "#008000"
                } else if (value < 1) {
                    color <- "#e00000"
                } else {
                    color <- "#777"
                }
                list(color = color, fontWeight = "bold")
            }),
        ind_safety_overall_perc = colDef(
            name = 'Individual Visit %',
            format = colFormat(percent = TRUE, digits = 1),
            style = function(value) {
                if (value >= 1) {
                    color <- "#008000"
                } else if (value < 1) {
                    color <- "#e00000"
                } else {
                    color <- "#777"
                }
                list(color = color, fontWeight = "bold")
            }),
        ind_safety_died = colDef(name = "Individual Safety Died"),
        ind_safety_migrated = colDef(name = "Individual Safety Migrated"),
        ind_safety_in = colDef(name = "Individual Safety-In"),
        ind_safety_in_absent = colDef(name = "Individual Safety-In Absent"),
        ind_safety_out = colDef(name = "Individual Safety-Out"),
        ind_safety_out_absent = colDef(name = "Individual Safety-Out Absent"),
        ind_safety_eos = colDef(name = "Individual Safety EOS"),
        ind_safety_refusal = colDef(name = "Individual Safety Refusal")
    ),
    columnGroups = list(
      colGroup(name = "Target", 
               columns = c('hh_target', 'ind_target')),
      colGroup(name = "Overall Completion", 
               columns = c('hh_safety_overall', 
                           'hh_safety_overall_perc', 
                           'ind_safety_overall', 
                           'ind_safety_overall_perc'))),
    highlight = TRUE,
    resizable = TRUE,
    bordered = TRUE,
    striped = TRUE,
    elementId = element_id
)

wrap_download(
  tbl, 
  element_id,
  'safety_by_cluster_and_villages.csv')
```

### Efficacy

```{r}
data_list <- list()
group_cols <- c('visit','cluster', 'village')
unique_visit_list <- efficacy_df$visit %>% unique()

# prep safety overall
data_list$overall <- prep_safety_tbl(
    safety_df = efficacy_df, 
    indicator = 'efficacy_overall',
    target_df = target_efficacy_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety in
data_list$in_status <- prep_safety_tbl(
  safety_df =  efficacy_df %>% 
    dplyr::filter(efficacy_status == 'in'),
  indicator = 'efficacy_in',
    target_df = target_efficacy_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety in & absent
data_list$in_absent_status <- prep_safety_tbl(
  safety_df =  efficacy_df %>%
    dplyr::filter(
      efficacy_status == 'in',
      person_absent_reason == 'Absent'),
  indicator = 'efficacy_in_absent',
    target_df = target_efficacy_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety refusal
data_list$refusal_status <- prep_safety_tbl(
  safety_df = efficacy_df %>% 
    dplyr::filter(efficacy_status == 'refusal'),
  indicator = 'efficacy_refusal',
    target_df = target_efficacy_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety eos
data_list$eos_status <- prep_safety_tbl(
  safety_df = efficacy_df %>% 
    dplyr::filter(efficacy_status == 'eos'),
  indicator = 'efficacy_eos',
    target_df = target_efficacy_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety eos
data_list$out_status <- prep_safety_tbl(
  safety_df = efficacy_df %>% 
    dplyr::filter(efficacy_status == 'out'),
  indicator = 'efficacy_out',
    target_df = target_efficacy_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety out absent
data_list$out_absent_status <- prep_safety_tbl(
  safety_df = efficacy_df %>% 
    dplyr::filter(safety_status == 'out',
                  person_absent_reason == 'Absent'),
    indicator = 'efficacy_out_absent',
    target_df = target_efficacy_by_cluster_and_village,
    group_cols = group_cols,
    visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))


# prep safety out absent
data_list$migrated_status <- prep_safety_tbl(
  safety_df = efficacy_df %>% 
    dplyr::filter(person_absent_reason == 'Migrated'),
  indicator = 'efficacy_migrated',
  target_df = target_efficacy_by_cluster_and_village,
  group_cols = group_cols,
  visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))

# prep safety out absent
data_list$died_status <- prep_safety_tbl(
  safety_df = efficacy_df %>% 
    dplyr::filter(person_absent_reason == 'Died'),
  indicator = 'efficacy_died',
  target_df = target_efficacy_by_cluster_and_village,
  group_cols = group_cols,
  visit_list = unique_visit_list
) %>% dplyr::mutate(village = toupper(village))
```

```{r}
summary <- target_efficacy_by_cluster_and_village %>%
    dplyr::inner_join(purrr::reduce(data_list, dplyr::bind_rows), 
                      by = group_cols) %>%
    tidyr::pivot_wider(names_from = metric, 
                       id_cols = c(any_of(group_cols), 'hh_target', 'ind_target'),
                       values_from = c('ind','hh')) %>% 
    dplyr::mutate(hh_efficacy_overall_perc = hh_efficacy_overall / hh_target,
                  ind_efficacy_overall_perc = ind_efficacy_overall / ind_target) %>% 
    dplyr::select(any_of(group_cols),
                  hh_target, 
                  ind_target, 
                  hh_efficacy_overall,
                  hh_efficacy_overall_perc,
                  ind_efficacy_overall,
                  ind_efficacy_overall_perc,
                  ind_efficacy_died,
                  ind_efficacy_migrated,
                  ind_efficacy_in,
                  ind_efficacy_in_absent,
                  ind_efficacy_out,
                  ind_efficacy_out_absent,
                  ind_efficacy_eos,
                  ind_efficacy_refusal) %>%
  dplyr::mutate(across(everything(), .fns = ~replace_na(.,0)))


element_id <- 'tbl4'
tbl <- reactable(
    summary %>% dplyr::ungroup(),
    columns = list(
        visit = colDef(name = 'Visit', filterable = TRUE),
        cluster = colDef(name = 'Cluster', filterable = TRUE),
        village = colDef(name = 'Village', filterable = TRUE, minWidth = 140),
        hh_target = colDef(name = "Target Household"),
        ind_target = colDef(name = "Target Individual"),
        hh_efficacy_overall = colDef(name = "Household Visits"),
        ind_efficacy_overall = colDef(name = "Individual Visits"),
        hh_efficacy_overall_perc = colDef(
            name = 'Household Visit %',
            format = colFormat(percent = TRUE, digits = 1),
            style = function(value) {
                if (value >= 1) {
                    color <- "#008000"
                } else if (value < 1) {
                    color <- "#e00000"
                } else {
                    color <- "#777"
                }
                list(color = color, fontWeight = "bold")
            }),
        ind_efficacy_overall_perc = colDef(
            name = 'Individual Visit %',
            format = colFormat(percent = TRUE, digits = 1),
            style = function(value) {
                if (value >= 1) {
                    color <- "#008000"
                } else if (value < 1) {
                    color <- "#e00000"
                } else {
                    color <- "#777"
                }
                list(color = color, fontWeight = "bold")
            }),
        ind_efficacy_died = colDef(name = "Individual Safety Died"),
        ind_efficacy_migrated = colDef(name = "Individual Safety Migrated"),
        ind_efficacy_in = colDef(name = "Individual Safety-In"),
        ind_efficacy_in_absent = colDef(name = "Individual Safety-In Absent"),
        ind_efficacy_out = colDef(name = "Individual Safety-Out"),
        ind_efficacy_out_absent = colDef(name = "Individual Safety-Out Absent"),
        ind_efficacy_eos = colDef(name = "Individual Safety EOS"),
        ind_efficacy_refusal = colDef(name = "Individual Safety Refusal")
    ),
    columnGroups = list(
      colGroup(name = "Target", 
               columns = c('hh_target', 'ind_target')),
      colGroup(name = "Overall Completion", 
               columns = c('hh_efficacy_overall', 
                           'hh_efficacy_overall_perc', 
                           'ind_efficacy_overall', 
                           'ind_efficacy_overall_perc'))),
    highlight = TRUE,
    resizable = TRUE,
    bordered = TRUE,
    striped = TRUE,
    elementId = element_id
)

wrap_download(
  tbl, 
  element_id,
  'efficacy_by_clusters_and_villages.csv')
```

## PFU 

No data collection yet

## CL Performance

```{r}

element_id <- 'attendance-tracker'

master <- dplyr::bind_rows(
  safety %>% 
    dplyr::select(wid, instanceID, SubmissionDate) %>% 
    dplyr::mutate(form_id = 'safety',
                  wid = as.character(wid)), 
  safetynew %>% 
    dplyr::select(wid, instanceID, SubmissionDate)%>% 
    dplyr::mutate(form_id = 'safetynew',
                  wid = as.character(wid)),
  efficacy %>% 
    dplyr::select(wid, instanceID, SubmissionDate)%>% 
    dplyr::mutate(form_id = 'efficacy',
                  wid = as.character(wid))
)


attendance <- master %>% 
    dplyr::mutate(metric_date = lubridate::date(SubmissionDate)) %>% 
    dplyr::group_by(wid, metric_date) %>% 
    dplyr::summarise(n_submission = n_distinct(instanceID)) %>%
    dplyr::ungroup() %>%
    dplyr::select(
      wid,
      date = metric_date,
      submission = n_submission)

tbl <- reactable(
  attendance,
  groupBy = "wid",
  columns = list(
    wid= colDef(name = "Worker ID", filterable = TRUE),
    date = colDef(
      name = "Submitted Date",
      aggregate = "count",
      format = list(
        aggregated = colFormat(suffix = " dates")
      )
    ),
    submission = colDef(
      name = "Submissions",
      aggregate = "sum"
    )
  ),
    highlight = TRUE,
    resizable = TRUE,
    bordered = TRUE,
    striped = TRUE,
    elementId = element_id
)


wrap_download(
  tbl, 
  element_id,
  'safety_efficacy_cl_performance.csv')
```
