---
title: "Ento Dataset for Sponsors"
description: |
  Reporting used to track V0 demography data collection in Kwale
output:
  html_document:
    toc: true
    theme: cerulean
date: '`r Sys.time()`'
---

Notes:

- Report is refreshed hourly 9-5pm EAT, once 12AM EAT
- Please reach out to atediarjo@gmail.com for bug reports

Description:

This report is used for sponsor to fetch ento datasets via [reports](https://docs.google.com/spreadsheets/d/13kc2jV8kcqJCIHdUo75NtDMY_QfV_0E0vgT-QvQRRtc/edit#gid=0)

```{r, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(
  comment = '', 
  echo = FALSE,
  message = FALSE,
  cache=FALSE,
  warning=FALSE
)
```

```{r, echo=FALSE, message=FALSE}
library(reactable)
library(data.table)
library(dplyr)
library(htmltools)
library(glue)
library(fontawesome)
library(ggplot2)
library(plotly)
```

```{r, echo = FALSE, message=FALSE}

wrap_download <- function(reactable_obj, element_id, output_filename){
  onclick_command <- glue::glue(
    "Reactable.downloadDataCSV('{element_id}', '{output_filename}')")
  htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download as CSV"),
      onclick = onclick_command),
    reactable_obj
  ))
}
```


```{r}
# variables / creds for ento
env_pipeline_stage <- Sys.getenv("PIPELINE_STAGE")
bucket_source <- 'databrew.org'
bucket_lake_db <- 'bohemia-lake-db'
input_key <- list(
  v0 = 'kwale/clean-form/v0demography/v0demography.csv',
  entostoragebox = 'kwale/clean-form/entostoragebox/entostoragebox.csv',
  entoltfield = 'kwale/clean-form/entoltfield/entoltfield.csv',
  entoltparitywing = 'kwale/clean-form/entoltparitywing/entoltparitywing.csv',
  entorcmorphid = 'kwale/clean-form/entorcmorphid/entorcmorphid.csv'
)
tryCatch({
  logger::log_info('Attempt AWS login')
  # login to AWS - this will be bypassed if executed in CI/CD environment
  cloudbrewr::aws_login(
    role_name = 'cloudbrewr-aws-role',
    profile_name =  'cloudbrewr-aws-role',
    pipeline_stage = env_pipeline_stage)

}, error = function(e){
  logger::log_error('AWS Login Failed')
  stop(e$message)
})
```


```{r}
v0demography <- cloudbrewr::aws_s3_get_table(
  bucket = bucket_source,
  key = input_key$v0)

entostoragebox<- cloudbrewr::aws_s3_get_table(
  bucket = bucket_source,
  key = input_key$entostoragebox)

entoltfield <- cloudbrewr::aws_s3_get_table(
  bucket = bucket_source,
  key = input_key$entoltfield)

entoltparitywing <- cloudbrewr::aws_s3_get_table(
  bucket = bucket_source,
  key = input_key$entoltparitywing)

entorcmorphid <- cloudbrewr::aws_s3_get_table(
  bucket = bucket_source,
  key = input_key$entorcmorphid)
```

### Light Trap Tubes
```{r}
df <- entoltfield %>% 
    dplyr::select(todays_date,site,instance_label,trap_success,hhid) %>% 
    dplyr::mutate(cluster = gsub('.{3}$', '', hhid))

reactable(df, filterable = TRUE)
```
